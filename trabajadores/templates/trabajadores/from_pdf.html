{% if request.user.is_staff %}
<div class="form-container">
    <!-- Men√∫ desplegable para seleccionar el tipo de descarga -->
    <div class="form-group">
        <label for="tipo_descarga">¬øQuieres descargar registro de ventas?:</label>
        <select id="tipo_descarga" class="form-control" onchange="mostrarFormulario()">
            <option value="">-- Selecciona por d√≠a, rango de fechas o producto --</option>
            <option value="dia">Ventas del D√≠a</option>
            <option value="rango">Ventas por Rango de Fechas</option>
        </select>
    </div>

    <!-- Formulario 1: Ventas del D√≠a -->
    <div id="form-dia" style="display: none;">
        <h4>Ventas del D√≠a</h4>
        <form method="get" action="{% url 'venta_export_pdf' %}" class="form-inline">
            <button type="submit" onclick="return confirmarDescarga();" class="btn btn-danger mb-3">
                <i class="fas fa-file-pdf"></i> Descargar PDF del D√≠a
            </button>
        </form>
    </div>

    <!-- Formulario 2: Ventas por Rango de Fechas (ahora con Producto) -->
    <div id="form-rango" style="display: none;">
        <h4>Ventas por Rango de Fechas</h4>
        <form id="form-rango-fechas" method="get" action="{% url 'venta_export_pdf' %}" class="form-inline">
            <div class="form-group">
                <label for="fecha_inicio">Fecha inicio:</label>
                <input type="date" id="fecha_inicio" name="fecha_inicio" value="{{ request.GET.fecha_inicio }}" class="form-control" required onchange="validarFechas()">
            </div>
            <div class="form-group">
                <label for="fecha_fin">Fecha fin:</label>
                <input type="date" id="fecha_fin" name="fecha_fin" value="{{ request.GET.fecha_fin }}" class="form-control" required onchange="validarFechas()">
            </div>
            <div class="form-group">
                <label for="vendedor">Vendedor:</label>
                <select id="vendedor" name="vendedor" class="form-control" onchange="validarFechas()">
                    <option value="">Todos los vendedores</option>
                    {% for vendedor in vendedores %}
                        <option value="{{ vendedor.id }}" {% if request.GET.vendedor|add:"" == vendedor.id|add:"" %}selected{% endif %}>
                            {{ vendedor.username }}
                        </option>
                    {% endfor %}
                </select>
            </div>
            <div class="form-group">
                <label for="producto">Producto:</label>
                <select id="producto" name="producto" class="form-control" onchange="validarFechas()">
                    <option value="">Todos los productos</option>
                    {% for producto in productos %}
                        <option value="{{ producto.id }}">{{ producto.nombre }}</option>  
                    {% endfor %}
                </select>
                
            </div>
            <div class="form-group">
                <label for="metodo_pago">M√©todo de Pago:</label>
                <select id="metodo_pago" name="metodo_pago" class="form-control" onchange="validarFechas()">
                    <option value="">Todos los m√©todos</option>
                    <option value="efectivo">Efectivo</option>
                    <option value="tarjeta">Tarjeta</option>
                    <option value="transferencia">Transferencia</option>
                </select>
            </div>  
            <button type="submit" class="btn btn-danger mb-3" onclick="return confirmarDescarga()" disabled>
                <i class="fas fa-file-pdf"></i> Descargar PDF
            </button>
            <div id="error-fechas" style="color: red; display: none;"></div>
            <div id="no-registros" style="color: red; display: none;">No hay registros en el rango de fechas seleccionado.</div>
        </form>
    </div>
</div>

<script>
function mostrarFormulario() {
    document.getElementById("form-dia").style.display = "none";
    document.getElementById("form-rango").style.display = "none";

    const tipoDescarga = document.getElementById("tipo_descarga").value;
    if (tipoDescarga === "dia") {
        document.getElementById("form-dia").style.display = "block";
    } else if (tipoDescarga === "rango") {
        document.getElementById("form-rango").style.display = "block";
    }
}

function validarFechas() {
    const fechaInicio = document.getElementById("fecha_inicio").value;
    const fechaFin = document.getElementById("fecha_fin").value;
    const vendedor = document.getElementById("vendedor").value;
    const producto = document.getElementById("producto").value;
    const metodoPago = document.getElementById("metodo_pago").value;
    const submitButton = document.querySelector("#form-rango-fechas button[type='submit']");
    const noRegistros = document.getElementById("no-registros");

    let url = `{% url "validar_ventas" %}?fecha_inicio=${fechaInicio}&fecha_fin=${fechaFin}`;
    if (vendedor) url += `&vendedor=${vendedor}`;
    if (producto) url += `&producto=${producto}`;
    if (metodoPago) url += `&metodo_pago=${metodoPago}`;

    //console.log(" Enviando solicitud a:", url); 

    fetch(url)
        .then(response => response.json())
        .then(data => {
            //console.log("üì¨ Respuesta recibida:", data); 
            if (data.existe) {
                submitButton.disabled = false;
                noRegistros.style.display = "none";
            } else {
                submitButton.disabled = true;
                noRegistros.style.display = "block";
            }
        })
        .catch(error => {
            //console.error("‚ùå Error en fetch:", error);
            submitButton.disabled = true;
        });
}


function confirmarDescarga() {
    return confirm("¬øEst√°s seguro de que deseas descargar el PDF?");
}
</script>
{% endif %}
